<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & METADATA -->
    <title>AteÅŸten Topraklar: DÃ¼nya SavaÅŸÄ± Stratejisi</title>
    <meta name="description" content="AteÅŸten Topraklar - GerÃ§ek dÃ¼nya haritasÄ± Ã¼zerinde geÃ§en epik strateji, diplomasi ve fetih oyunu. Ordunu yÃ¶net, sÄ±nÄ±rlarÄ± Ã§iz ve dÃ¼nyaya hÃ¼kmet. Sungu Erdem sunar.">
    <meta name="keywords" content="strateji oyunu, dÃ¼nya savaÅŸÄ±, harita oyunu, fetih, diplomasi, tarayÄ±cÄ± oyunu, maplibre, threejs, savaÅŸ simÃ¼lasyonu, ateÅŸten topraklar">
    <meta name="author" content="Sungu Erdem">
    <meta name="robots" content="index, follow">
    
    <!-- Social Media Tags (Open Graph) -->
    <meta property="og:title" content="AteÅŸten Topraklar: KÃ¼resel Hakimiyet">
    <meta property="og:description" content="SÄ±nÄ±rlarÄ± Ã§iz, kaderini belirle. GerÃ§ek dÃ¼nya haritasÄ±nda geÃ§en, ittifak ve savaÅŸ dolu bir strateji deneyimi.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sunguerdem.com/atesten-topraklar">
    <meta property="og:image" content="https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1000&auto=format&fit=crop">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AteÅŸten Topraklar">
    <meta name="twitter:description" content="DÃ¼nya senin oyun alanÄ±n. Ordunu kur ve fethetmeye baÅŸla.">
    
    <!-- MapLibre GL JS (Harita) -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Three.js (3D Arka Plan) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Uyumluluk -->
    <script>
        if (typeof maplibregl !== 'undefined') { window.mapboxgl = maplibregl; }
    </script>

    <!-- Mapbox Draw (Ã‡izim) -->
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" type="text/css" />

    <!-- Turf.js (Geometri Hesaplama) -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* TEMA RENKLERÄ°: ATEÅžTEN TOPRAKLAR */
            --neon-fire: #ff3b00;
            --neon-gold: #ffcc00;
            --glass-bg: rgba(20, 5, 5, 0.85); 
            --glass-border: rgba(255, 60, 0, 0.25);
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            color: #fff;
        }

        /* --- 3D BACKDROP: YANAN ATMOSFER --- */
        #three-canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: radial-gradient(circle at center, #2e0a0a 0%, #000000 90%);
        }

        /* --- MAP --- */
        #map { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 0;
        }
        
        .cursor-pen .mapboxgl-canvas-container {
            cursor: url('https://img.icons8.com/fluency-systems-filled/48/FFFFFF/edit.png') 0 48, auto !important;
        }

        /* --- UI ELEMENTS --- */
        .ui-layer {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none;
            perspective: 1000px;
        }
        
        .pointer-events-auto { pointer-events: auto; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 40px rgba(255, 60, 0, 0.15);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        /* Kartlar */
        .holo-card {
            background: linear-gradient(135deg, rgba(255,60,0,0.05) 0%, rgba(0,0,0,0.5) 100%);
            border: 1px solid rgba(255,60,0,0.2);
            transform-style: preserve-3d;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27), box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .holo-card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: var(--neon-gold);
            box-shadow: 0 0 25px rgba(255, 60, 0, 0.4);
        }

        /* BaÅŸlÄ±k AteÅŸ Efekti */
        .title-3d {
            text-shadow: 0 0 15px var(--neon-fire), 0 0 30px var(--neon-fire);
            animation: fireGlow 3s infinite alternate;
        }

        @keyframes fireGlow {
            0% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff4500; filter: brightness(1); }
            50% { text-shadow: 0 0 20px #ff4500, 0 0 40px #ffcc00; filter: brightness(1.2); }
            100% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff4500; filter: brightness(1); }
        }

        /* Butonlar: Magma Stili */
        .btn-3d {
            background: linear-gradient(90deg, rgba(180, 20, 0, 0.2), rgba(255, 100, 0, 0.2));
            border: 1px solid rgba(255, 60, 0, 0.4);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-3d:hover {
            background: linear-gradient(90deg, #ff3b00, #ffcc00);
            box-shadow: 0 0 20px rgba(255, 60, 0, 0.6);
            transform: scale(1.05);
            border-color: #fff;
            color: #000;
            font-weight: 900;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.8); }
        ::-webkit-scrollbar-thumb { background: #802000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ff4500; }

        /* Coin Animation */
        .coin {
            width: 100px; height: 100px; 
            background: radial-gradient(circle, #ffd700 0%, #b8860b 100%);
            border-radius: 50%; border: 4px solid #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; color: #4a3b00;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
            transform-style: preserve-3d;
        }
        .coin-flip { animation: flip 2s ease-out forwards; }
        @keyframes flip { 0% { transform: rotateY(0); } 100% { transform: rotateY(1800deg); } }

        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 3D BACKGROUND (THREE.JS) -->
    <div id="three-canvas-container"></div>

    <!-- MAP (GAMEPLAY) -->
    <div id="map"></div>

    <!-- UI LAYER -->
    <div class="ui-layer flex flex-col">
        
        <!-- LOBBY SCREEN -->
        <div id="lobbyScreen" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-auto z-50">
            
            <div class="relative z-10 flex flex-col items-center w-full max-w-6xl h-full py-10 px-4 justify-center">
                
                <!-- MAIN TITLE -->
                <div class="text-center mb-6 mt-12 md:mt-16 lg:mt-20">
                    <h1 class="text-6xl md:text-8xl lg:text-9xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-yellow-400 via-orange-500 to-red-700 title-3d select-none transform scale-y-110 leading-none pb-2">
                        ATEÅžTEN<br>TOPRAKLAR
                    </h1>
                    <p class="text-orange-300 font-bold text-sm md:text-lg tracking-[0.4em] uppercase mt-4 opacity-80 text-shadow">
                        Kader Ã‡izgisi & KÃ¼resel Hakimiyet
                    </p>
                </div>

                <p id="lobbyStatus" class="text-red-500 font-mono text-xs tracking-[0.3em] animate-pulse mb-10 uppercase font-bold bg-black/40 px-4 py-1 rounded-full border border-red-900/50">
                    Sistemler HazÄ±rlanÄ±yor...
                </p>

                <!-- Step 1: Setup Config -->
                <div id="setupConfig" class="hidden glass-panel p-8 max-w-md w-full fade-in-up flex flex-col gap-6 border-t-4 border-t-orange-600">
                    <h2 class="text-2xl font-black text-white border-b border-white/10 pb-4 text-center italic uppercase">SavaÅŸ OdasÄ±</h2>
                    
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase tracking-[0.2em] text-red-400 font-bold">Ä°nsan Komutanlar</label>
                        <div class="relative group">
                            <select id="humanCount" class="w-full bg-black/60 border border-red-900 rounded-none p-3 text-white focus:border-orange-500 outline-none appearance-none font-bold tracking-wider transition-colors group-hover:bg-red-900/20">
                                <option value="1">1 General</option>
                                <option value="2" selected>2 General</option>
                                <option value="3">3 General</option>
                                <option value="4">4 General</option>
                            </select>
                            <div class="absolute right-4 top-3 pointer-events-none text-orange-500"><i class="fas fa-user-shield"></i></div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] uppercase tracking-[0.2em] text-red-400 font-bold">Yapay Zeka DÃ¼ÅŸmanlar</label>
                        <div class="relative group">
                            <select id="aiCount" class="w-full bg-black/60 border border-red-900 rounded-none p-3 text-white focus:border-orange-500 outline-none appearance-none font-bold tracking-wider transition-colors group-hover:bg-red-900/20">
                                <option value="0">Tehdit Yok</option>
                                <option value="1">1 Lejyon</option>
                                <option value="2" selected>2 Lejyon</option>
                                <option value="3">3 Lejyon</option>
                                <option value="4">4 Lejyon</option>
                                <option value="5">5 Lejyon</option>
                            </select>
                            <div class="absolute right-4 top-3 pointer-events-none text-red-600"><i class="fas fa-robot"></i></div>
                        </div>
                    </div>

                    <button onclick="goToCountrySelect()" class="btn-3d w-full py-4 mt-4 group text-lg font-black skew-x-[-5deg] hover:skew-x-0 transition-transform">
                        CEPHEYE GÄ°T
                    </button>
                </div>

                <!-- Step 2: Country Selection -->
                <div id="countryListContainer" class="hidden w-full h-full flex flex-col fade-in-up relative pt-4">
                    <div class="glass-panel w-full p-4 mb-4 flex items-center justify-between border-l-8 border-l-orange-600 shrink-0">
                        <div>
                            <h2 id="playerSelectTitle" class="text-2xl md:text-3xl font-black text-white italic uppercase">1. General SeÃ§imi</h2>
                            <p class="text-orange-400 text-xs tracking-[0.4em] mt-1 font-bold">BAÅžLANGIÃ‡ ÃœSSÃœNÃœ BELÄ°RLE</p>
                        </div>
                        <div class="h-12 w-12 rounded-full bg-gradient-to-br from-orange-500 to-red-700 flex items-center justify-center shadow-[0_0_30px_rgba(255,69,0,0.6)] animate-pulse">
                            <i class="fas fa-crosshairs text-xl text-white"></i>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                        <div id="countryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 pb-20">
                            <!-- Kartlar JS ile buraya gelecek -->
                        </div>
                    </div>
                </div>

                <!-- Ä°MZA FOOTER -->
                <div class="absolute bottom-6 w-full text-center pointer-events-none">
                    <div class="inline-block px-6 py-2 glass-panel rounded-full border-none bg-black/40 backdrop-blur-sm">
                        <p class="text-[10px] md:text-xs text-gray-400 tracking-[0.3em] uppercase font-bold opacity-70">
                            <span class="text-orange-500">Sungu Erdem</span> gururla sunar. &copy; 2025 TÃ¼m Telif HaklarÄ± SaklÄ±dÄ±r.
                        </p>
                    </div>
                </div>

            </div>
        </div>

        <!-- IN-GAME UI -->
        <div id="gameUI" class="hidden w-full h-full relative">
            
            <!-- Left Sidebar: Stats -->
            <div class="absolute top-4 left-4 w-80 flex flex-col gap-3 pointer-events-auto max-h-[90vh] overflow-y-auto pr-1">
                <!-- Player Stats Card -->
                <div class="glass-panel p-5 rounded-2xl border-l-4 border-white/20" id="playerStatsPanel">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span id="playerLabel" class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">Oyuncu 1</span>
                            <h2 class="text-2xl font-black text-white leading-none truncate w-48" id="countryNameDisplay">ÃœLKE ADI</h2>
                        </div>
                        <div id="turnIndicator" class="h-8 px-3 flex items-center justify-center bg-white/10 rounded text-[10px] font-bold uppercase tracking-widest border border-white/10">
                            SIRA SENDE
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-black/30 p-2 rounded border border-white/5">
                            <div class="text-[10px] text-gray-400 uppercase">Hazine</div>
                            <div id="moneyDisplay" class="text-green-400 font-mono font-bold text-lg">5.000$</div>
                        </div>
                        <div class="bg-black/30 p-2 rounded border border-white/5">
                            <div class="text-[10px] text-gray-400 uppercase">Toprak</div>
                            <div id="areaDisplay" class="text-blue-400 font-mono font-bold text-xs mt-1">0 kmÂ²</div>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center p-2 bg-white/5 rounded">
                            <span class="text-gray-400"><i class="fas fa-shield-alt w-5"></i> Askeri</span>
                            <span id="militaryDisplay" class="font-bold">50</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white/5 rounded">
                            <span class="text-gray-400"><i class="fas fa-microchip w-5"></i> Teknoloji</span>
                            <span id="techDisplay" class="font-bold">T1</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white/5 rounded">
                            <span class="text-gray-400"><i class="fas fa-fire w-5"></i> Moral</span>
                            <span id="moraleDisplay" class="font-bold text-yellow-400">70%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white/5 rounded">
                            <span class="text-gray-400"><i class="fas fa-eye w-5"></i> Ä°stihbarat</span>
                            <span id="intelDisplay" class="font-bold">0</span>
                        </div>
                    </div>

                    <button onclick="collectTax()" id="btnTax" class="mt-4 w-full btn-3d py-3 rounded text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        VERGÄ° TOPLA
                    </button>
                </div>

                <!-- Actions Card -->
                <div class="glass-panel p-4 rounded-2xl pointer-events-auto">
                    <div class="flex justify-between items-center mb-3 border-b border-white/10 pb-2">
                        <span class="font-bold text-sm uppercase">Stratejik Hamleler</span>
                        <span id="cooldownInfo" class="text-[10px] text-gray-500">HAZIR</span>
                    </div>
                    <div class="space-y-2">
                        <button onclick="investMilitary()" id="btnMilitary" class="w-full text-left px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/5 rounded transition flex items-center justify-between group">
                            <span class="text-xs font-bold">ASKERÄ° YATIRIM</span>
                            <span class="text-xs text-gray-400 group-hover:text-white">800$</span>
                        </button>
                        <button onclick="boostTech()" id="btnTech" class="w-full text-left px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/5 rounded transition flex items-center justify-between group">
                            <span class="text-xs font-bold">AR-GE PROJESÄ°</span>
                            <span class="text-xs text-gray-400 group-hover:text-white">600$</span>
                        </button>
                        <button onclick="inspirePeople()" id="btnMorale" class="w-full text-left px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/5 rounded transition flex items-center justify-between group">
                            <span class="text-xs font-bold">PROPAGANDA</span>
                            <span class="text-xs text-gray-400 group-hover:text-white">400$</span>
                        </button>
                        <button onclick="openDiplomacyMenu()" id="btnDiplomacy" class="w-full text-left px-4 py-3 bg-blue-900/40 hover:bg-blue-800/50 border border-blue-500/30 rounded transition flex items-center justify-between group mt-2">
                            <span class="text-xs font-bold text-blue-200">DÄ°PLOMASÄ° (Ä°TTÄ°FAK)</span>
                            <span class="text-xs text-gray-400 group-hover:text-white"><i class="fas fa-handshake"></i></span>
                        </button>
                    </div>
                </div>
                
                <!-- Allies List -->
                <div id="alliesPanel" class="glass-panel p-3 rounded-xl hidden">
                    <h3 class="text-xs font-bold text-green-400 uppercase mb-2 border-b border-white/10 pb-1">MÃ¼ttefikler</h3>
                    <ul id="alliesList" class="text-xs text-gray-300 space-y-1"></ul>
                </div>
            </div>

            <!-- AI Thinking Overlay -->
            <div id="aiThinking" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden pointer-events-none">
                <div class="glass-panel px-8 py-6 rounded-full flex items-center gap-6 border border-purple-500/30 shadow-[0_0_50px_rgba(168,85,247,0.2)]">
                    <div class="relative">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-400"></div>
                        <div class="absolute inset-0 rounded-full h-10 w-10 border-2 border-purple-400/20 animate-ping"></div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xl font-bold text-white tracking-widest" id="aiActionText">YAPAY ZEKA ANALÄ°Z EDÄ°YOR...</span>
                        <span class="text-[10px] text-purple-300 uppercase tracking-[0.4em]">Neural Network Processing</span>
                    </div>
                </div>
            </div>

            <!-- Bottom Controls -->
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex flex-col items-center gap-4 pointer-events-auto w-full max-w-2xl px-4">
                <div id="statusMessage" class="glass-panel px-8 py-2 rounded-full text-sm font-semibold text-cyan-100 border border-cyan-500/20 tracking-[0.2em] uppercase shadow-[0_0_20px_rgba(0,243,255,0.1)]">
                    OYUN BAÅžLIYOR...
                </div>
                
                <div id="controlsContainer" class="glass-panel p-3 rounded-2xl flex gap-3 items-center w-full justify-center shadow-2xl bg-black/80">
                    <button id="btnDraw" onclick="startDrawMode()" class="flex-1 btn-3d py-4 rounded-xl transition flex items-center justify-center gap-3 font-bold disabled:opacity-30 disabled:cursor-not-allowed group">
                        <i class="fas fa-pen-fancy text-xl group-hover:rotate-12 transition-transform"></i> 
                        <span class="tracking-widest">SINIR Ã‡Ä°Z (FETHET)</span>
                    </button>
                    <div class="h-10 w-px bg-white/10 mx-2"></div>
                    <button id="btnBridge" onclick="activateBridgeMode()" class="flex-1 bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 px-6 py-4 rounded-xl transition flex items-center justify-center gap-3 font-semibold disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-water"></i> 
                        <span>KÃ–PRÃœ (1000$)</span>
                    </button>
                </div>
            </div>
            
            <!-- Log -->
            <div id="gameLog" class="absolute bottom-8 right-8 glass-panel p-4 rounded-xl w-80 h-48 overflow-y-auto text-xs space-y-2 hidden lg:block font-mono pointer-events-auto shadow-2xl opacity-80 hover:opacity-100 transition-opacity">
                <div class="text-green-400 border-b border-white/10 pb-1 mb-2">>> SÄ°STEM GÃœNLÃœÄžÃœ</div>
                <div class="text-gray-300">SimÃ¼lasyon HazÄ±r.</div>
            </div>
        </div>
    </div>

    <!-- DIPLOMACY MODAL -->
    <div id="diplomacyModal" class="fixed inset-0 z-[8000] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-md mx-4 border border-blue-500/30">
            <h2 class="text-2xl font-black text-white mb-4 text-center uppercase tracking-wider">Ä°ttifak Teklifi</h2>
            <div id="diplomacyList" class="space-y-2 mb-4"></div>
            <button onclick="document.getElementById('diplomacyModal').classList.add('hidden')" class="w-full py-3 bg-white/10 rounded hover:bg-white/20 text-sm uppercase font-bold">Kapat</button>
        </div>
    </div>

    <!-- COIN FLIP MODAL -->
    <div id="coinFlipModal" class="fixed inset-0 z-[9000] flex items-center justify-center bg-black/90 backdrop-blur-lg hidden transition-all duration-500">
        <div class="glass-panel p-10 rounded-3xl text-center max-w-lg mx-4 border border-yellow-500/30 shadow-[0_0_100px_rgba(234,179,8,0.2)] transform scale-100 w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-yellow-500/5 pointer-events-none"></div>
            <h2 class="text-4xl font-black text-white mb-2 uppercase tracking-tighter relative z-10">KADER ANI</h2>
            <p id="coinDesc" class="text-gray-300 mb-1 relative z-10">Bu topraklarÄ± fethetmek iÃ§in ÅŸansÄ±nÄ± dene!</p>
            <p id="coinOdds" class="text-yellow-500/80 text-xs uppercase tracking-[0.4em] mb-8 font-bold relative z-10">BaÅŸarÄ± Analizi: %50</p>
            <div class="flex justify-center mb-12 h-40 items-center perspective-1000 relative z-10">
                <div id="coin" class="coin">?</div>
            </div>
            <div id="coinButtons" class="grid grid-cols-2 gap-6 relative z-10">
                <button onclick="playCoinFlip('YazÄ±')" class="btn-3d py-5 rounded-xl text-2xl shadow-lg font-black border-yellow-500/30 hover:border-yellow-400 text-yellow-100">YAZI</button>
                <button onclick="playCoinFlip('Tura')" class="btn-3d py-5 rounded-xl text-2xl shadow-lg font-black border-yellow-500/30 hover:border-yellow-400 text-yellow-100">TURA</button>
            </div>
            <div id="coinResultMsg" class="hidden mt-4 text-3xl font-bold relative z-10 drop-shadow-lg"></div>
            <button id="btnCloseModal" onclick="finishAndNextTurn()" class="hidden w-full mt-8 btn-3d py-4 rounded-xl relative z-10">DEVAM ET</button>
        </div>
    </div>

    <script>
        /* --- THREE.JS BACKGROUND SETUP --- */
        let scene, camera, renderer, globe, stars;
        let isThreeActive = true;

        function initThree() {
            const container = document.getElementById('three-canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x200505, 0.02);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 14;
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            const geometry = new THREE.IcosahedronGeometry(6, 2);
            const material = new THREE.MeshBasicMaterial({ color: 0xff4500, wireframe: true, transparent: true, opacity: 0.4 });
            globe = new THREE.Mesh(geometry, material);
            scene.add(globe);
            const coreGeo = new THREE.IcosahedronGeometry(5.8, 2);
            const coreMat = new THREE.MeshBasicMaterial({ color: 0x330000 });
            const core = new THREE.Mesh(coreGeo, coreMat);
            scene.add(core);
            const starGeo = new THREE.BufferGeometry();
            const starCount = 1500;
            const posArray = new Float32Array(starCount * 3);
            const velocityArray = new Float32Array(starCount); 
            for(let i = 0; i < starCount * 3; i+=3) {
                posArray[i] = (Math.random() - 0.5) * 60;     
                posArray[i+1] = (Math.random() - 0.5) * 60;   
                posArray[i+2] = (Math.random() - 0.5) * 40;   
                velocityArray[i/3] = Math.random() * 0.05 + 0.01; 
            }
            starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const starMat = new THREE.PointsMaterial({ size: 0.12, color: 0xffaa00, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending });
            stars = new THREE.Points(starGeo, starMat);
            scene.add(stars);
            let time = 0;
            function animate() {
                if (!isThreeActive) return;
                requestAnimationFrame(animate);
                time += 0.005;
                globe.rotation.y += 0.004;
                globe.rotation.x = Math.sin(time) * 0.1;
                const scale = 1 + Math.sin(time * 2) * 0.02;
                core.scale.set(scale, scale, scale);
                const positions = stars.geometry.attributes.position.array;
                for(let i = 1; i < starCount * 3; i+=3) {
                    positions[i] += velocityArray[(i-1)/3]; 
                    if (positions[i] > 30) { positions[i] = -30; }
                }
                stars.geometry.attributes.position.needsUpdate = true;
                camera.position.x += (Math.sin(time * 3) * 0.01);
                camera.position.y += (Math.cos(time * 2) * 0.01);
                renderer.render(scene, camera);
            }
            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        /* --- OYUN DEÄžÄ°ÅžKENLERÄ° --- */
        let map, draw;
        let worldGeoJSON = null;
        let bridgeActive = false;
        let taxCollectedThisTurn = false;
        
        let players = []; 
        let turnIndex = 0;
        let currentSetupIndex = 0; 
        let targetHumanCount = 0;
        let targetAICount = 0;
        let strategyLocked = false;

        // Fetih DeÄŸiÅŸkenleri
        let pendingActionType = 'conquest'; 
        let pendingConquestFeature = null;
        let pendingConquestCost = 0;
        let pendingConquestLoot = 0;
        let pendingConquestArea = 0;
        let pendingDefenderIndex = -1; // -1 ise nÃ¶tr, >=0 ise oyuncu
        let pendingConquestOdds = 50;

        const MAP_COLORS = ['#e6b8af', '#f4cccc', '#fce5cd', '#fff2cc', '#d9ead3', '#d0e0e3', '#c9daf8', '#cfe2f3', '#d9d2e9', '#ead1dc', '#dd7e6b', '#ea9999', '#f9cb9c', '#ffe599', '#b6d7a8', '#a2c4c9', '#a4c2f4', '#9fc5e8', '#b4a7d6', '#d5a6bd'];
        const PLAYER_COLORS = ["#00f3ff", "#bc13fe", "#ffff00", "#ff0055", "#00ff99", "#ff9900"];
        const regionDisplay = (typeof Intl !== 'undefined' && typeof Intl.DisplayNames !== 'undefined') ? new Intl.DisplayNames(['tr'], { type: 'region' }) : null;

        function getISO2(feature) { return (feature.properties.ISO_A2_EH || feature.properties.ISO_A2 || "").toUpperCase(); }
        function getLocalizedCountryName(feature) {
            const base = feature.properties.NAME || feature.properties.ADMIN || "Bilinmeyen";
            const iso2 = getISO2(feature);
            if (regionDisplay && iso2 && iso2.length === 2) { try { return regionDisplay.of(iso2) || base; } catch(e) { return base; } }
            return base;
        }
        function getFlagEmoji(iso2) {
            if (!iso2 || iso2.length !== 2) return "ðŸ³ï¸";
            const codePoints = [...iso2.toUpperCase()].map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }
        function formatCurrency(value) { return `${Math.round(value).toLocaleString('tr-TR')}$`; }
        function formatArea(value) { return `${Math.round(value).toLocaleString('tr-TR')} kmÂ²`; }
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        window.onload = async function() {
            initThree(); 
            try {
                if (typeof maplibregl !== 'undefined' && typeof mapboxgl === 'undefined') { window.mapboxgl = maplibregl; }
                const response = await fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson');
                if (!response.ok) throw new Error("Veri hatasÄ±");
                worldGeoJSON = await response.json();
                if (worldGeoJSON && worldGeoJSON.features) {
                    worldGeoJSON.features.forEach((feature, index) => {
                        feature.properties.__staticColor = MAP_COLORS[index % MAP_COLORS.length];
                    });
                }
                document.getElementById('lobbyStatus').classList.add('hidden');
                document.getElementById('setupConfig').classList.remove('hidden'); 
            } catch (error) { 
                console.error(error); 
                document.getElementById('lobbyStatus').innerText = "VERÄ° HATASI";
            }
        };

        function goToCountrySelect() {
            targetHumanCount = parseInt(document.getElementById('humanCount').value);
            targetAICount = parseInt(document.getElementById('aiCount').value);
            const configDiv = document.getElementById('setupConfig');
            configDiv.style.transform = "translateY(-20px)";
            configDiv.style.opacity = "0";
            setTimeout(() => {
                configDiv.classList.add('hidden');
                const listDiv = document.getElementById('countryListContainer');
                listDiv.classList.remove('hidden');
                populateCountryGrid();
                updateSetupTitle();
            }, 300);
        }

        function updateSetupTitle() { document.getElementById('playerSelectTitle').innerText = `${currentSetupIndex + 1}. OYUNCU SEÃ‡Ä°MÄ°`; }
        function populateCountryGrid() {
            const grid = document.getElementById('countryGrid');
            grid.innerHTML = '';
            const sortedFeatures = worldGeoJSON.features.sort((a, b) => getLocalizedCountryName(a).localeCompare(getLocalizedCountryName(b), 'tr'));
            sortedFeatures.forEach(feature => {
                const iso3 = feature.properties.ISO_A3 || feature.properties.ADM0_A3;
                if (!iso3 || iso3 === "-99" || players.some(p => p.iso === iso3)) return;
                const name = getLocalizedCountryName(feature);
                const iso2 = getISO2(feature);
                const flag = getFlagEmoji(iso2);
                const card = document.createElement('div');
                card.className = "holo-card rounded-xl p-4 flex flex-col items-center justify-center gap-2 group";
                card.innerHTML = `<span class="text-4xl drop-shadow-md transform group-hover:scale-110 transition-transform duration-300">${flag}</span><span class="text-center font-bold text-sm text-gray-200 group-hover:text-cyan-400 transition-colors leading-tight">${name}</span><div class="absolute bottom-0 left-0 w-full h-1 bg-white/10 group-hover:bg-cyan-400 transition-colors"></div>`;
                card.onclick = () => selectHumanCountry(feature, iso3);
                grid.appendChild(card);
            });
        }

        function selectHumanCountry(feature, iso) {
            const name = getLocalizedCountryName(feature);
            const iso2 = getISO2(feature);
            const flag = getFlagEmoji(iso2);
            const color = PLAYER_COLORS[players.length % PLAYER_COLORS.length];
            players.push({
                id: players.length,
                name: `Oyuncu ${currentSetupIndex + 1}`,
                displayName: name,
                iso: iso,
                isAI: false,
                color: color,
                money: 5000,
                military: 50 + Math.floor(Math.random() * 20),
                techLevel: 1,
                morale: 75,
                intel: 0,
                flag: flag,
                geoJSON: feature,
                center: turf.center(feature).geometry.coordinates,
                zoom: 3.5,
                isDead: false,
                allies: [] 
            });
            currentSetupIndex++;
            if (currentSetupIndex < targetHumanCount) { updateSetupTitle(); populateCountryGrid(); } 
            else { generateAIPlayers(); }
        }

        function generateAIPlayers() {
            let available = worldGeoJSON.features.filter(f => {
                const iso = f.properties.ISO_A3 || f.properties.ADM0_A3;
                return iso && iso !== "-99" && !players.some(p => p.iso === iso);
            });
            for (let i = 0; i < targetAICount; i++) {
                if (available.length === 0) break;
                const randIdx = Math.floor(Math.random() * available.length);
                const feature = available[randIdx];
                available.splice(randIdx, 1);
                const name = getLocalizedCountryName(feature);
                const iso2 = getISO2(feature);
                const flag = getFlagEmoji(iso2);
                const color = PLAYER_COLORS[players.length % PLAYER_COLORS.length];
                players.push({
                    id: players.length,
                    name: `AI: ${name}`,
                    displayName: name,
                    iso: feature.properties.ISO_A3,
                    isAI: true,
                    color: color,
                    money: 5000,
                    military: 60 + Math.floor(Math.random() * 30),
                    techLevel: 1,
                    morale: 80,
                    intel: 5,
                    flag: flag,
                    geoJSON: feature,
                    center: turf.center(feature).geometry.coordinates,
                    zoom: 3.5,
                    isDead: false,
                    allies: [] 
                });
            }
            startGame();
        }

        function startGame() {
            isThreeActive = false;
            const threeContainer = document.getElementById('three-canvas-container');
            threeContainer.style.transition = "opacity 1s";
            threeContainer.style.opacity = "0";
            setTimeout(() => { threeContainer.classList.add('hidden'); }, 1000);
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
            initMap();
        }

        function initMap() {
            const p = players[0];
            map = new maplibregl.Map({
                container: 'map',
                style: { "version": 8, "sources": { "carto-dark": { "type": "raster", "tiles": ["https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"], "tileSize": 256 } }, "layers": [{ "id": "background", "type": "raster", "source": "carto-dark", "minzoom": 0 }] },
                center: p.center, zoom: p.zoom, pitch: 40, bearing: 0, antialias: true
            });
            map.on('load', () => {
                if (map && typeof map.setFog === 'function') { map.setFog({ 'range': [0.5, 10], 'color': '#1a1a2e', 'horizon-blend': 0.1 }); }
                addColoredWorldLayer();
                players.forEach((player, idx) => addPlayerLayer(player, idx));
                setupDrawTool();
                startNextTurn();
            });
        }

        function addColoredWorldLayer() {
            if (!worldGeoJSON) return;
            map.addSource('world-base', { type: 'geojson', data: worldGeoJSON });
            map.addLayer({ id: 'world-base-fill', type: 'fill', source: 'world-base', paint: { 'fill-color': ['get', '__staticColor'], 'fill-opacity': 0.3, 'fill-outline-color': '#000' } });
            map.addLayer({ id: 'world-base-outline', type: 'line', source: 'world-base', paint: { 'line-color': '#555', 'line-width': 0.5, 'line-opacity': 0.5 } });
        }

        function addPlayerLayer(player, idx) {
            const sourceId = `player-source-${idx}`;
            map.addSource(sourceId, { 'type': 'geojson', 'data': player.geoJSON });
            map.addLayer({ 'id': `player-3d-${idx}`, 'type': 'fill-extrusion', 'source': sourceId, 'paint': { 'fill-extrusion-color': player.color, 'fill-extrusion-height': 40000, 'fill-extrusion-base': 0, 'fill-extrusion-opacity': 0.9 } });
            map.addLayer({ 'id': `player-border-${idx}`, 'type': 'line', 'source': sourceId, 'paint': { 'line-color': '#fff', 'line-width': 2, 'line-opacity': 0.8, 'line-blur': 1 } });
        }

        function updatePlayerLayer(idx) {
            const p = players[idx];
            const source = map.getSource(`player-source-${idx}`);
            if (source && p.geoJSON) source.setData(p.geoJSON);
            else if (source && !p.geoJSON) source.setData({type: 'FeatureCollection', features: []});
        }

        function startNextTurn() {
            while(players[turnIndex].isDead) { turnIndex = (turnIndex + 1) % players.length; }
            const p = players[turnIndex];
            taxCollectedThisTurn = false;
            bridgeActive = false;
            resetBridgeBtn();
            strategyLocked = p.isAI;
            updateUIForPlayer(p);
            if (p.isAI) { lockUI(true); runAITurn(p); } 
            else {
                lockUI(false);
                document.getElementById('statusMessage').innerText = `${p.name}, HAMLE SIRASI SENDE.`;
                log(`TUR: ${p.name} komutasÄ±nda.`);
                map.flyTo({ center: p.center, zoom: p.zoom, speed: 1.2, curve: 1 });
            }
        }

        function finishAndNextTurn() {
            document.getElementById('coinFlipModal').classList.add('hidden');
            checkElimination(); 
            turnIndex = (turnIndex + 1) % players.length;
            startNextTurn();
        }

        function checkElimination() {
            let activeCount = 0;
            let survivor = null;
            players.forEach((p, idx) => {
                if(p.isDead) return;
                let dead = false;
                if(p.money <= 0) { dead = true; log(`${p.name} Ä°FLAS ETTÄ°.`); }
                else if(!p.geoJSON || turf.area(p.geoJSON) < 10000) { dead = true; log(`${p.name} Ä°ÅžGAL EDÄ°LDÄ°.`); }
                if(dead) {
                    p.isDead = true;
                    if(map.getLayer(`player-3d-${idx}`)) map.setLayoutProperty(`player-3d-${idx}`, 'visibility', 'none');
                    if(map.getLayer(`player-border-${idx}`)) map.setLayoutProperty(`player-border-${idx}`, 'visibility', 'none');
                } else { activeCount++; survivor = p; }
            });
            if(activeCount === 1 && players.length > 1) {
                alert(`OYUN BÄ°TTÄ°! KAZANAN: ${survivor.name}`);
                location.reload();
            }
        }

        function updateUIForPlayer(p) {
            document.getElementById('playerLabel').innerText = p.isAI ? "YAPAY ZEKA KONTROLÃœ" : `OPERATÃ–R: ${p.id + 1}`;
            document.getElementById('countryNameDisplay').innerText = `${p.flag} ${p.displayName}`;
            document.getElementById('playerStatsPanel').style.borderColor = p.color;
            const area = p.geoJSON ? turf.area(p.geoJSON) / 1000000 : 0;
            document.getElementById('moneyDisplay').innerText = formatCurrency(p.money);
            document.getElementById('areaDisplay').innerText = formatArea(area);
            document.getElementById('militaryDisplay').innerText = Math.round(p.military);
            document.getElementById('techDisplay').innerText = `Lv. ${p.techLevel}`;
            document.getElementById('moraleDisplay').innerText = `%${Math.round(p.morale)}`;
            document.getElementById('intelDisplay').innerText = Math.round(p.intel || 0);
            const taxBtn = document.getElementById('btnTax');
            if (taxBtn) {
                if (!taxCollectedThisTurn) { taxBtn.innerText = "VERGÄ° TOPLA"; taxBtn.className = "mt-4 w-full btn-3d py-3 rounded text-xs font-bold disabled:opacity-50"; } 
                else { taxBtn.className = "mt-4 w-full bg-white/5 text-gray-500 border border-white/5 py-3 rounded text-xs font-bold cursor-not-allowed"; }
                taxBtn.disabled = p.isAI || taxCollectedThisTurn;
            }
            updateStrategyButtons(p);
            document.getElementById('turnIndicator').innerText = p.isAI ? "AI" : "SENDE";
            
            // MÃ¼ttefik Listesi
            const alliesList = document.getElementById('alliesList');
            const alliesPanel = document.getElementById('alliesPanel');
            alliesList.innerHTML = '';
            if(p.allies.length > 0) {
                alliesPanel.classList.remove('hidden');
                p.allies.forEach(allyId => {
                    const ally = players[allyId];
                    if(!ally.isDead) {
                        const li = document.createElement('li');
                        li.innerText = `ðŸ¤ ${ally.name} (${ally.displayName})`;
                        alliesList.appendChild(li);
                    }
                });
            } else {
                alliesPanel.classList.add('hidden');
            }
        }

        function updateStrategyButtons(p) {
            const disabled = strategyLocked || p.isAI;
            ['btnMilitary','btnTech','btnMorale'].forEach(id => {
                const btn = document.getElementById(id);
                if(!btn) return;
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
                btn.classList.toggle('cursor-not-allowed', disabled);
            });
            const dipBtn = document.getElementById('btnDiplomacy');
            if(dipBtn) {
                dipBtn.disabled = disabled;
                dipBtn.classList.toggle('opacity-50', disabled);
            }
            document.getElementById('cooldownInfo').innerText = disabled ? "KÄ°LÄ°TLÄ°" : "HAZIR";
        }

        function lockUI(locked) {
            const controls = document.getElementById('controlsContainer');
            controls.style.opacity = locked ? "0.3" : "1";
            controls.style.pointerEvents = locked ? "none" : "auto";
        }

        function collectTax() {
            if (taxCollectedThisTurn) return;
            const p = players[turnIndex];
            if (!p.geoJSON) return;
            const area = turf.area(p.geoJSON) / 1000000;
            const income = Math.floor(area * 0.02) + 300 + (p.techLevel * 50);
            p.money += income;
            p.morale = clamp(p.morale + 2, 0, 100);
            taxCollectedThisTurn = true;
            updateUIForPlayer(p);
            log(`EKONOMÄ°: +${income}$ kaynak saÄŸlandÄ±.`);
            document.getElementById('btnTax').innerText = `TOPLANDI (+${income}$)`;
        }

        function performStrategyAction(cost, type, callback) {
            const p = players[turnIndex];
            if (strategyLocked || p.money < cost) {
                if(!p.isAI) alert("Yetersiz kaynak veya hamle yapÄ±ldÄ±.");
                return;
            }
            p.money -= cost;
            callback(p);
            strategyLocked = true;
            updateUIForPlayer(p);
            log(`STRATEJÄ°: ${p.name} ${type} hamlesi yaptÄ±.`);
        }

        function investMilitary() { performStrategyAction(800, "Askeri", p => { p.military += 10; p.morale += 2; }); }
        function boostTech() { performStrategyAction(600, "Teknoloji", p => { p.techLevel++; p.intel += 3; }); }
        function inspirePeople() { performStrategyAction(400, "Propaganda", p => { p.morale += 15; }); }

        // --- DÄ°PLOMASÄ° (Ä°TTÄ°FAK) SÄ°STEMÄ° ---
        function openDiplomacyMenu() {
            const p = players[turnIndex];
            if(strategyLocked) return;
            
            const list = document.getElementById('diplomacyList');
            list.innerHTML = '';
            const others = players.filter(x => x.id !== p.id && !x.isDead);

            if(others.length === 0) {
                list.innerHTML = '<div class="text-gray-400 text-center">BaÅŸka Ã¼lke kalmadÄ±.</div>';
            } else {
                others.forEach(other => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-white/5 p-3 rounded hover:bg-white/10";
                    const isAlly = p.allies.includes(other.id);
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${other.flag}</span>
                            <span class="text-sm font-bold text-white">${other.name}</span>
                        </div>
                        <button onclick="offerAlliance(${other.id})" 
                            class="text-[10px] font-bold px-3 py-2 rounded ${isAlly ? 'bg-green-900 text-green-200 cursor-default' : 'bg-blue-600 hover:bg-blue-500 text-white'}" 
                            ${isAlly ? 'disabled' : ''}>
                            ${isAlly ? 'MÃœTTEFÄ°K' : 'TEKLÄ°F ET (500$)'}
                        </button>
                    `;
                    list.appendChild(div);
                });
            }
            document.getElementById('diplomacyModal').classList.remove('hidden');
        }

        function offerAlliance(targetId) {
            const p = players[turnIndex];
            const target = players[targetId];
            const cost = 500;

            if(p.money < cost) { alert("Yetersiz bakiye (500$)"); return; }
            
            p.money -= cost;
            document.getElementById('diplomacyModal').classList.add('hidden');
            
            // AI KararÄ±
            const acceptChance = 0.7; 
            const accepted = Math.random() < acceptChance;

            if(accepted) {
                p.allies.push(targetId);
                target.allies.push(p.id);
                log(`DÄ°PLOMASÄ°: ${p.name} ve ${target.name} Ä°TTÄ°FAK kurdu!`);
                alert(`${target.name} ittifak teklifini KABUL etti!`);
            } else {
                log(`DÄ°PLOMASÄ°: ${target.name}, ${p.name}'in teklifini reddetti.`);
                alert(`${target.name} ittifak teklifini REDDETTÄ°.`);
            }
            
            strategyLocked = true;
            updateUIForPlayer(p);
        }

        // --- AI MANTIÄžI (GELÄ°ÅžMÄ°Åž) ---
        async function runAITurn(ai) {
            const thinkingDiv = document.getElementById('aiThinking');
            const thinkingText = document.getElementById('aiActionText');
            thinkingDiv.classList.remove('hidden');

            if(ai.money < 2000) {
                thinkingText.innerText = "KAYNAK YÃ–NETÄ°MÄ°...";
                await wait(1000);
                collectTax();
            }

            if(ai.money > 4500 && !strategyLocked) {
                if(ai.morale < 60) inspirePeople();
                else if(ai.military < 50) investMilitary();
                else boostTech();
            }

            thinkingText.innerText = "SINIR HATTI TARANIYOR...";
            await wait(1000);

            const analysis = findSmartTarget(ai);
            const targetFeature = analysis.feature;
            const targetCenter = analysis.center;
            const needsBridge = !analysis.isNeighbor;

            if(!targetFeature) {
                thinkingText.innerText = "HEDEF BULUNAMADI (TAM Ä°ZOLASYON)";
                await wait(1500);
                thinkingDiv.classList.add('hidden');
                finishAndNextTurn();
                return;
            }

            map.flyTo({ center: targetCenter.geometry.coordinates, zoom: 4.5 });

            if (needsBridge) {
                thinkingText.innerText = "DENÄ°Z AÅžIRI SEFER (KÃ–PRÃœ GEREKLÄ°)...";
                await wait(1000);
                const bridgeCost = 1000;
                
                if (ai.money < bridgeCost + 600) {
                    thinkingText.innerText = "SEFER Ä°Ã‡Ä°N BÃœTÃ‡E YETERSÄ°Z";
                    await wait(1500);
                    thinkingDiv.classList.add('hidden');
                    finishAndNextTurn();
                    return;
                }
                
                thinkingText.innerText = "OKYANUS KÃ–PRÃœSÃœ Ä°NÅžA EDÄ°LÄ°YOR (%50)";
                await wait(1500);
                
                if (Math.random() > 0.5) {
                     ai.money -= bridgeCost;
                     log(`AI MÃœHENDÄ°SLÄ°K: ${ai.name} okyanus kÃ¶prÃ¼sÃ¼ kurdu.`);
                     thinkingText.innerText = "KÃ–PRÃœ KURULDU!";
                     await wait(1000);
                } else {
                     ai.money -= 500;
                     log(`AI FELAKET: ${ai.name} kÃ¶prÃ¼ projesinde battÄ±.`);
                     thinkingText.innerText = "KÃ–PRÃœ Ã‡Ã–KTÃœ! TUR BÄ°TTÄ°.";
                     await wait(2000);
                     thinkingDiv.classList.add('hidden');
                     finishAndNextTurn();
                     return;
                }
            } else {
                thinkingText.innerText = "KARA SINIRINDAN SALDIRILIYOR";
                await wait(1000);
            }

            thinkingText.innerText = "ORDULAR Ä°LERLÄ°YOR...";
            const attackPoly = createSmartAttackPolygon(ai, targetFeature, targetCenter, ai.money);
            
            map.addSource('ai-attack', {type:'geojson', data: attackPoly});
            map.addLayer({ id: 'ai-attack-line', type: 'line', source: 'ai-attack', paint: {'line-color': '#ff0000', 'line-width': 4, 'line-dasharray': [2,1]} });

            await wait(1500);
            const areaSqKm = Math.round(turf.area(attackPoly) / 1000000);
            const cost = Math.max(500, Math.floor(areaSqKm * 1.5));

            if(ai.money >= cost) {
                thinkingText.innerText = `MALÄ°YET: ${formatCurrency(cost)}`;
                await wait(1500);
                const conquestSuccess = Math.random() > 0.5; 

                const defenderIdx = identifyDefender(attackPoly, ai.id);

                if(conquestSuccess) {
                    ai.money -= cost;
                    ai.money += Math.floor(cost * 1.2);
                    thinkingText.innerText = "ZAFER! TOPRAKLAR KATILDI";
                    stealLand(ai, attackPoly);
                    ai.military += 2;
                    log(`AI ZAFERÄ°: ${ai.name} ${areaSqKm} kmÂ² geniÅŸledi.`);
                } else {
                    ai.money -= Math.floor(cost / 2);
                    thinkingText.innerText = "BOZGUN! (CEZA: TOPRAK KAYBI)";
                    log(`AI YENÄ°LGÄ°SÄ°: ${ai.name} pÃ¼skÃ¼rtÃ¼ldÃ¼.`);
                    transferPenaltyToDefender(turnIndex, defenderIdx, attackPoly);
                }
            } else {
                thinkingText.innerText = "SALDIRI Ä°Ã‡Ä°N BAKÄ°YE YETERSÄ°Z";
            }

            await wait(1500);
            if(map.getLayer('ai-attack-line')) map.removeLayer('ai-attack-line');
            if(map.getSource('ai-attack')) map.removeSource('ai-attack');
            thinkingDiv.classList.add('hidden');
            finishAndNextTurn();
        }

        function findSmartTarget(ai) {
            const occupiedISOs = players.map(p => p.iso).filter(x => x);
            
            let neighbors = [];
            let distantTargets = [];

            const isTouching = (feature) => {
                if (!ai.geoJSON) return false;
                try {
                    return !turf.booleanDisjoint(ai.geoJSON, feature);
                } catch(e) { return false; }
            };

            // 1. NÃ¶tr Ãœlkeleri Tara
            worldGeoJSON.features.forEach(f => {
                const iso = f.properties.ISO_A3 || f.properties.ADM0_A3;
                if (!iso || iso === "-99" || occupiedISOs.includes(iso)) return;

                if (isTouching(f)) {
                    neighbors.push({ feature: f, center: turf.center(f), type: 'neutral' });
                } else {
                    const center = turf.center(f);
                    const dist = turf.distance(turf.center(ai.geoJSON), center, {units: 'kilometers'});
                    if (dist < 3000) {
                        distantTargets.push({ feature: f, center: center, dist: dist, type: 'neutral' });
                    }
                }
            });

            // 2. DÃ¼ÅŸmanlarÄ± Tara
            players.forEach(p => {
                if (p.id !== ai.id && !p.isDead && p.geoJSON && !ai.allies.includes(p.id)) {
                    if (isTouching(p.geoJSON)) {
                        neighbors.push({ feature: p.geoJSON, center: turf.center(p.geoJSON), type: 'enemy' });
                    } else {
                        const center = turf.center(p.geoJSON);
                        const dist = turf.distance(turf.center(ai.geoJSON), center, {units: 'kilometers'});
                        if (dist < 3000) {
                            distantTargets.push({ feature: p.geoJSON, center: center, dist: dist, type: 'enemy' });
                        }
                    }
                }
            });
            
            if (neighbors.length > 0) {
                const target = neighbors[Math.floor(Math.random() * neighbors.length)];
                return { feature: target.feature, center: target.center, isNeighbor: true };
            }

            if (distantTargets.length > 0) {
                distantTargets.sort((a, b) => a.dist - b.dist);
                const count = Math.min(3, distantTargets.length);
                const target = distantTargets[Math.floor(Math.random() * count)];
                return { feature: target.feature, center: target.center, isNeighbor: false };
            }

            return { feature: null, isNeighbor: false };
        }

        function createSmartAttackPolygon(ai, targetFeature, targetCenter, budget) {
            const aiCenter = turf.center(ai.geoJSON);
            const safeBudget = Math.max(500, budget * 0.9); 
            const maxAffordableArea = safeBudget / 1.5;
            const maxRadiusKm = Math.sqrt(maxAffordableArea / Math.PI);
            let radius = Math.max(15, Math.min(maxRadiusKm, 150));
            radius = radius * (0.8 + Math.random() * 0.2);
            const bearing = turf.bearing(aiCenter, targetCenter);
            const dist = turf.distance(aiCenter, targetCenter, {units: 'kilometers'});
            let attackPoint;
            if (dist > radius * 2) { attackPoint = turf.destination(targetCenter, radius * 0.5, bearing - 180, {units: 'kilometers'}); } 
            else { attackPoint = turf.destination(aiCenter, dist * 0.8, bearing, {units: 'kilometers'}); }
            return turf.circle(attackPoint, radius, {units: 'kilometers', steps: 16});
        }

        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // --- OYUNCU Ã‡Ä°ZÄ°M & FETÄ°H ---
        function setupDrawTool() {
            draw = new MapboxDraw({
                displayControlsDefault: false,
                controls: { polygon: false, trash: false },
                styles: [ { 'id': 'gl-draw-polygon-fill-active', 'type': 'fill', 'paint': { 'fill-color': '#00f3ff', 'fill-opacity': 0.2 } }, { 'id': 'gl-draw-polygon-stroke-active', 'type': 'line', 'paint': { 'line-color': '#00f3ff', 'line-width': 3 } } ]
            });
            map.addControl(draw);
            map.on('draw.create', handleDrawCreate);
        }

        function startDrawMode() {
            if(players[turnIndex].isAI) return;
            draw.changeMode('draw_polygon');
            document.getElementById('map').classList.add('cursor-pen');
            document.getElementById('statusMessage').innerText = "HARÄ°TA ÃœZERÄ°NDE KAPALI BÄ°R ALAN Ã‡Ä°Z";
        }

        async function handleDrawCreate(e) {
            document.getElementById('map').classList.remove('cursor-pen');
            const data = draw.getAll();
            if (data.features.length > 0) {
                const polygon = data.features[0];
                draw.deleteAll();
                processConquestRequest(polygon);
            }
        }

        function processConquestRequest(feature) {
            const p = players[turnIndex];
            const areaSqKm = Math.round(turf.area(feature) / 1000000);
            const cost = Math.max(500, areaSqKm * 1.5);
            
            if(p.money < cost) { alert(`YETERSÄ°Z BAKÄ°YE! Gerekli: ${formatCurrency(cost)}`); return; }

            const defenderIdx = identifyDefender(feature, p.id);
            if (defenderIdx !== -1) {
                const defender = players[defenderIdx];
                if (p.allies.includes(defender.id)) {
                    alert(`MÃœTTEFÄ°K ATEÅžÄ°! ${defender.name} ile ittifak halindesin.`);
                    return;
                }
            }

            if(p.geoJSON && !bridgeActive) {
                 const intersection = turf.intersect(p.geoJSON, feature); 
                 try {
                    const disjoint = turf.booleanDisjoint(p.geoJSON, feature);
                    if(disjoint) { alert("SÄ±nÄ±r komÅŸusu deÄŸil! Ã–nce KÃ–PRÃœ kurmalÄ±sÄ±n."); return; }
                 } catch(e) {}
            }

            pendingActionType = 'conquest';
            pendingConquestFeature = feature;
            pendingConquestCost = cost;
            pendingConquestArea = areaSqKm;
            pendingConquestLoot = Math.floor(cost * 1.2);
            pendingDefenderIndex = defenderIdx;
            
            openCoinModal();
        }

        function identifyDefender(poly, attackerId) {
            let defId = -1;
            let maxInt = 0;
            players.forEach((p, idx) => {
                if(idx !== attackerId && !p.isDead && p.geoJSON) {
                    try {
                        const intersection = turf.intersect(p.geoJSON, poly);
                        if(intersection) {
                            const area = turf.area(intersection);
                            if(area > maxInt) { maxInt = area; defId = idx; }
                        }
                    } catch(e){}
                }
            });
            return defId;
        }

        function openCoinModal() {
            const modal = document.getElementById('coinFlipModal');
            modal.classList.remove('hidden');
            document.getElementById('coin').classList.remove('coin-flip');
            document.getElementById('coin').innerText = "?";
            document.getElementById('coinButtons').classList.remove('hidden');
            document.getElementById('coinResultMsg').classList.add('hidden');
            document.getElementById('btnCloseModal').classList.add('hidden');
            
            if (pendingActionType === 'bridge') {
                document.getElementById('coinDesc').innerText = `1000$ bÃ¼tÃ§eyle OKYANUS KÃ–PRÃœSÃœ projesi baÅŸlatÄ±lÄ±yor...`;
                document.getElementById('coinOdds').innerText = "Risk Analizi: %50 (BaÅŸarÄ±sÄ±zlÄ±k durumunda sÄ±ra geÃ§er)";
            } else {
                document.getElementById('coinDesc').innerText = `${formatCurrency(pendingConquestCost)} maliyetle ${pendingConquestArea} kmÂ² alan iÃ§in`;
                document.getElementById('coinOdds').innerText = "BaÅŸarÄ± Analizi: %50";
            }
        }

        function playCoinFlip(choice) {
            document.getElementById('coinButtons').classList.add('hidden');
            const coin = document.getElementById('coin');
            coin.classList.add('coin-flip');
            const result = Math.random() > 0.5 ? 'YazÄ±' : 'Tura';
            const win = (choice === result);
            setTimeout(() => {
                coin.innerText = result === 'YazÄ±' ? 'Y' : 'T';
                if (pendingActionType === 'bridge') resolveBridgeAttempt(win);
                else resolveConquest(win);
            }, 2000);
        }

        function resolveBridgeAttempt(win) {
            const p = players[turnIndex];
            const msg = document.getElementById('coinResultMsg');
            msg.classList.remove('hidden');
            document.getElementById('btnCloseModal').classList.remove('hidden');
            if (win) {
                msg.innerText = "KÃ–PRÃœ KURULDU!";
                msg.className = "mt-4 text-4xl font-black text-green-400 drop-shadow-lg";
                p.money -= 1000;
                bridgeActive = true;
                const btn = document.getElementById('btnBridge');
                btn.innerHTML = '<i class="fas fa-check"></i> AKTÄ°F';
                btn.classList.add('bg-cyan-500', 'text-black', 'border-cyan-400');
                btn.classList.remove('text-gray-300', 'border-white/10');
                updateUIForPlayer(p);
                log(`MÃœHENDÄ°SLÄ°K: ${p.name} okyanus kÃ¶prÃ¼sÃ¼ kurdu.`);
                document.getElementById('btnCloseModal').onclick = () => {
                    document.getElementById('coinFlipModal').classList.add('hidden');
                    document.getElementById('statusMessage').innerText = "ÅžÄ°MDÄ° FETHETMEK Ä°STEDÄ°ÄžÄ°N YERÄ° Ã‡Ä°Z!";
                };
                document.getElementById('btnCloseModal').innerText = "FETHETMEYE BAÅžLA";
            } else {
                msg.innerText = "Ã‡Ã–KÃœÅž! SIRA GEÃ‡TÄ°";
                msg.className = "mt-4 text-4xl font-black text-red-500 drop-shadow-lg animate-pulse";
                p.money -= 500;
                log(`FELAKET: ${p.name} kÃ¶prÃ¼ projesinde baÅŸarÄ±sÄ±z oldu.`);
                document.getElementById('btnCloseModal').onclick = finishAndNextTurn;
                document.getElementById('btnCloseModal').innerText = "TURU BÄ°TÄ°R";
            }
        }

        function resolveConquest(win) {
            const p = players[turnIndex];
            const msg = document.getElementById('coinResultMsg');
            msg.classList.remove('hidden');
            document.getElementById('btnCloseModal').classList.remove('hidden');
            document.getElementById('btnCloseModal').onclick = finishAndNextTurn;
            document.getElementById('btnCloseModal').innerText = "DEVAM ET";

            if(win) {
                msg.innerText = "ZAFER!";
                msg.className = "mt-4 text-4xl font-black text-green-400 drop-shadow-lg";
                p.money -= pendingConquestCost;
                p.money += pendingConquestLoot; 
                stealLand(p, pendingConquestFeature);
            } else {
                msg.innerText = "BOZGUN! (-TOPRAK)";
                msg.className = "mt-4 text-4xl font-black text-red-500 drop-shadow-lg";
                p.money -= Math.floor(pendingConquestCost / 2);
                transferPenaltyToDefender(turnIndex, pendingDefenderIndex, pendingConquestFeature);

                if (bridgeActive) {
                    bridgeActive = false;
                    resetBridgeBtn();
                    log(`YIKIM: Fetih baÅŸarÄ±sÄ±z olduÄŸu iÃ§in kÃ¶prÃ¼ imha edildi!`);
                }
            }
        }

        function stealLand(attacker, poly) {
            players.forEach((victim, idx) => {
                if(attacker.id === victim.id || !victim.geoJSON) return;
                try {
                    const diff = turf.difference(victim.geoJSON, poly);
                    if(diff) { victim.geoJSON = diff; updatePlayerLayer(idx); }
                } catch(e) {}
            });
            try {
                let union;
                if(attacker.geoJSON) union = turf.union(attacker.geoJSON, poly);
                else union = poly;
                if(union) { attacker.geoJSON = union; updatePlayerLayer(turnIndex); }
            } catch(e) {}
        }

        function transferPenaltyToDefender(attackerIdx, defenderIdx, attackPoly) {
            const attacker = players[attackerIdx];
            if (!attacker.geoJSON || turf.area(attacker.geoJSON) < 100000) return;

            try {
                const targetCenter = turf.center(attackPoly);
                const exploded = turf.explode(attacker.geoJSON);
                const nearestPoint = turf.nearest(targetCenter, exploded);

                const penaltyRadius = 40 + Math.random() * 20; 
                const penaltyPoly = turf.circle(nearestPoint, penaltyRadius, {units: 'kilometers'});

                const diff = turf.difference(attacker.geoJSON, penaltyPoly);
                if (diff) {
                    attacker.geoJSON = diff;
                    updatePlayerLayer(attackerIdx);
                    
                    if (defenderIdx !== -1 && players[defenderIdx] && !players[defenderIdx].isDead) {
                        const defender = players[defenderIdx];
                        let union;
                        if (defender.geoJSON) union = turf.union(defender.geoJSON, penaltyPoly);
                        else union = penaltyPoly;
                        
                        if (union) {
                            defender.geoJSON = union;
                            updatePlayerLayer(defenderIdx);
                            log(`KARÅžI SALDIRI: ${defender.name}, bozguna uÄŸrayan ${attacker.name}'dan toprak kopardÄ±!`);
                        }
                    } else {
                        log(`CEZA: ${attacker.name} bozgun sonrasÄ± sÄ±nÄ±rda toprak kaybetti.`);
                    }
                }
            } catch (e) {
                console.error("Ceza iÅŸlemi hatasÄ±:", e);
            }
        }

        function activateBridgeMode() {
            const p = players[turnIndex];
            if(p.money < 1000) { alert("Yetersiz Bakiye (En az 1000$ gerekli)"); return; }
            pendingActionType = 'bridge';
            openCoinModal();
        }
        
        function resetBridgeBtn() {
            const btn = document.getElementById('btnBridge');
            if(!btn) return;
            btn.innerHTML = '<i class="fas fa-water"></i> KÃ–PRÃœ (1000$)';
            btn.classList.remove('bg-cyan-500', 'text-black', 'border-cyan-400');
            btn.classList.add('text-gray-300', 'border-white/10');
            btn.disabled = false;
            bridgeActive = false;
        }

        function log(msg) {
            const div = document.getElementById('gameLog');
            div.innerHTML = `<div class="border-l-2 border-cyan-500/50 pl-2 mb-2"><span class="text-gray-500 text-[10px]">${new Date().toLocaleTimeString()}</span><br>${msg}</div>` + div.innerHTML;
        }
    </script>
</body>
</html>